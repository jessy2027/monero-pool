# =============================================================================
# HAProxy Configuration for EuroXMR SSL Stratum
# =============================================================================
# This configuration provides TLS termination for the Stratum mining protocol
# Miners can connect securely on port 4343 with SSL/TLS encryption
# =============================================================================

global
    log stdout format raw local0
    maxconn 4096
    # SSL tuning
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 10s
    timeout client  120s
    timeout server  120s
    retries 3

# =============================================================================
# Frontend: SSL Stratum (port 4343)
# =============================================================================
frontend stratum_ssl
    bind *:4343 ssl crt /etc/ssl/certs/euroxmr.pem
    mode tcp
    option tcplog
    
    # Connection limits per IP (anti-abuse)
    stick-table type ip size 100k expire 30s store conn_cur
    tcp-request connection track-sc0 src
    tcp-request connection reject if { sc0_conn_cur gt 10 }
    
    default_backend stratum_pool

# =============================================================================
# Backend: Monero Pool Stratum
# =============================================================================
backend stratum_pool
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Health check
    server pool1 monero-pool:4242 check inter 30s fall 3 rise 2
