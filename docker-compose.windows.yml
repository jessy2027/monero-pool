# =============================================================================
# Monero Pool - Docker Compose Configuration (WINDOWS)
# =============================================================================
# This file orchestrates the complete mining pool infrastructure:
# - monerod: Monero daemon (blockchain node)
# - monero-wallet-rpc: Wallet RPC for payouts
# - monero-pool: The mining pool server
#
# USAGE:
#   Start:   docker compose -f docker-compose.windows.yml up -d
#   Stop:    docker compose -f docker-compose.windows.yml down
#   Logs:    docker compose -f docker-compose.windows.yml logs -f
#   Update:  docker compose -f docker-compose.windows.yml build --no-cache && docker compose -f docker-compose.windows.yml up -d
#
# FOR LINUX: Use docker-compose.yml instead:
#   docker compose up -d
#
# DATA LOCATIONS (Windows):
#   ${DATA_DIR}\xmr-data       - Monero blockchain (~180 GB)
#   ${DATA_DIR}\xmr-wallet     - Wallet data
#   ${DATA_DIR}\xmr-pool-data  - Pool database (shares, payments, balances)
#   ${DATA_DIR}\config         - Configuration files
#   (Default DATA_DIR: C:\MoneroPool)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Monero Daemon (monerod)
  # ---------------------------------------------------------------------------
  monerod:
    image: ghcr.io/sethforprivacy/simple-monerod:latest
    container_name: monerod
    restart: always
    ports:
      - "18080:18080"  # P2P network
      - "18081:18081"  # RPC (restricted)
    volumes:
      - ${DATA_DIR:-C:\MoneroPool}\xmr-data:/home/monero/.bitmonero
    command:
      - "--rpc-bind-ip=0.0.0.0"
      - "--rpc-bind-port=18081"
      - "--confirm-external-bind"
      - "--restricted-rpc"
      - "--no-igd"
      - "--enable-dns-blocklist"
      - "--prune-blockchain"  # Use pruned blockchain (~70 GB instead of 180 GB)
    networks:
      - monero-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Monero Wallet RPC (for payouts)
  # ---------------------------------------------------------------------------
  monero-wallet-rpc:
    image: ghcr.io/sethforprivacy/simple-monero-wallet-rpc:latest
    container_name: monero-wallet-rpc
    restart: always
    depends_on:
      - monerod
    ports:
      - "28084:28084"  # Wallet RPC
    volumes:
      - ${DATA_DIR:-C:\MoneroPool}\xmr-wallet:/home/monero/wallet
      - ${DATA_DIR:-C:\MoneroPool}\config:/config:ro
    command:
      - "--daemon-host=monerod"
      - "--daemon-port=18081"
      - "--rpc-bind-port=28084"
      - "--wallet-file=/home/monero/wallet/pool-wallet"
      - "--password-file=/config/wallet-password.txt"
      - "--disable-rpc-login"
    networks:
      - monero-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Monero Pool
  # ---------------------------------------------------------------------------
  monero-pool:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: monero-pool
    restart: always
    depends_on:
      - monerod
      - monero-wallet-rpc
    ports:
      - "4242:4242"    # Stratum port (miners connect here)
      - "4244:4244"    # Trusted/Upstream port
      - "80:80"      # Web UI (mapped to 8080 on host to avoid conflicts)
    volumes:
      - ${DATA_DIR:-C:\MoneroPool}\xmr-pool-data:/app/data
      - ${DATA_DIR:-C:\MoneroPool}\config\pool.conf:/app/config/pool.conf:ro
      - ${DATA_DIR:-C:\MoneroPool}\lottery-output:/app/lottery:ro
      - ${DATA_DIR:-C:\MoneroPool}\lottery-data:/app/lottery-data:ro
    environment:
      - TZ=Europe/Paris
    networks:
      - monero-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    # Health check is defined in Dockerfile

  # ---------------------------------------------------------------------------
  # Tari Base Node (for merge mining)
  # ---------------------------------------------------------------------------
  # Enable with: docker compose --profile tari up -d
  # ---------------------------------------------------------------------------
  tari-base-node:
    image: quay.io/tarilabs/minotari_node:latest
    container_name: tari-base-node
    restart: unless-stopped
    profiles: ["tari"]  # Only starts with: docker compose --profile tari up -d
    ports:
      - "18142:18142"  # gRPC port
      - "18189:18189"  # P2P port
    volumes:
      - ${DATA_DIR:-C:\MoneroPool}\tari-data:/var/tari
      - ${DATA_DIR:-C:\MoneroPool}\config\tari:/var/tari/config
    environment:
      - TARI_NETWORK=esmeralda
      - TARI_BASE_NODE__USE_LIBTOR=1
      - TARI_BASE_NODE__GRPC_ENABLED=true
      - TARI_BASE_NODE__GRPC_ADDRESS=/ip4/0.0.0.0/tcp/18142
    networks:
      - monero-network
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Tari Console Wallet (for XTM payouts)
  # ---------------------------------------------------------------------------
  tari-wallet:
    image: quay.io/tarilabs/minotari_console_wallet:latest
    container_name: tari-wallet
    restart: unless-stopped
    profiles: ["tari"]
    depends_on:
      - tari-base-node
    ports:
      - "18143:18143"  # Wallet gRPC port
    volumes:
      - ${DATA_DIR:-C:\MoneroPool}\tari-wallet:/var/tari/wallet
      - ${DATA_DIR:-C:\MoneroPool}\config\tari:/var/tari/config
      - ${DATA_DIR:-C:\MoneroPool}\config:/config:ro
    environment:
      - TARI_NETWORK=esmeralda
      - TARI_WALLET__GRPC_ENABLED=true
      - TARI_WALLET__GRPC_ADDRESS=/ip4/0.0.0.0/tcp/18143
      - TARI_BASE_NODE__ADDRESS=/dns4/tari-base-node/tcp/18142
    networks:
      - monero-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # HAProxy for SSL Stratum (TLS termination)
  # ---------------------------------------------------------------------------
  # NOTE: This service requires a valid SSL certificate to work!
  # Create the cert file first: C:\MoneroPool\config\certs\euroxmr.pem
  # Then uncomment and start: docker compose --profile ssl up -d haproxy
  # ---------------------------------------------------------------------------
  haproxy:
    image: haproxy:2.8-alpine
    container_name: haproxy-ssl
    restart: unless-stopped
    profiles: ["ssl"]  # Only starts with: docker compose --profile ssl up -d
    depends_on:
      - monero-pool
    ports:
      - "4343:4343"    # SSL Stratum port (miners connect here for TLS)
      - "443:443"      # HTTPS Web UI (SSL)
    volumes:
      - ${DATA_DIR:-C:\MoneroPool}\config\haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ${DATA_DIR:-C:\MoneroPool}\config\certs:/etc/ssl/certs:ro
    command: ["haproxy", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
    networks:
      - monero-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Lottery Cron Service
  # ---------------------------------------------------------------------------
  # Runs scheduled tasks for the lottery system:
  # - Generates lottery_stats.json every hour (for web UI)
  # - Runs the lottery draw every Sunday at 20:00 CET
  # ---------------------------------------------------------------------------
  lottery-cron:
    build:
      context: .
      dockerfile: tools/Dockerfile.lottery
    container_name: lottery-cron
    restart: unless-stopped
    profiles: ["lottery"]  # Only starts with: docker compose --profile lottery up -d
    volumes:
      # Pool database (read-only access to shares)
      - ${DATA_DIR:-C:\MoneroPool}\xmr-pool-data:/app/data:ro
      # Output directory for lottery_stats.json (served by web UI)
      - ${DATA_DIR:-C:\MoneroPool}\lottery-output:/app/output
      # Lottery results persistent storage
      - ${DATA_DIR:-C:\MoneroPool}\lottery-data:/app/lottery-data
    environment:
      - TZ=Europe/Paris
      - LOTTERY_PRIZE=0.02
      - LOTTERY_PERIOD=7
    networks:
      - monero-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# Networks
# =============================================================================
networks:
  monero-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# Notes (Windows):
# =============================================================================
# 
# FIRST TIME SETUP:
# 1. Run the management script:
#    manage.bat setup
#
# 2. Edit pool configuration:
#    notepad ${DATA_DIR:-C:\MoneroPool}\config\pool.conf
#
# 3. Create wallet (run once):
#    manage.bat create-wallet
#
# 4. Start everything:
#    manage.bat start
#
# 5. Monitor logs:
#    manage.bat logs
#
# BACKUP:
#   - ${DATA_DIR:-C:\MoneroPool}\xmr-pool-data contains all pool data (CRITICAL - backup daily)
#   - ${DATA_DIR:-C:\MoneroPool}\xmr-wallet contains wallet files (CRITICAL - backup securely)
#   - ${DATA_DIR:-C:\MoneroPool}\xmr-data can be re-synced if lost
#
# UPDATE POOL:
#   manage.bat update
#
# LOTTERY SYSTEM:
#   1. Directories are created by setup
#
#   2. Build and start lottery service:
#      manage.bat start-lottery
#
#   3. View lottery logs:
#      manage.bat logs lottery-cron
#
#   4. The lottery_stats.json is generated in ${DATA_DIR:-C:\MoneroPool}\lottery-output
# =============================================================================
