# =============================================================================
# Monero Pool - TEST Configuration (Upstream + Downstream on same machine)
# =============================================================================
# Ce fichier crée deux pools pour tester la communication upstream/downstream:
# - pool-upstream: Le pool maître qui écoute sur le port trusted
# - pool-downstream: Le pool esclave qui se connecte à l'upstream
#
# USAGE:
#   Start:   docker compose -f docker-compose.test.yml up -d
#   Stop:    docker compose -f docker-compose.test.yml down
#   Logs:    docker compose -f docker-compose.test.yml logs -f
#   
#   Logs Upstream:   docker compose -f docker-compose.test.yml logs -f pool-upstream
#   Logs Downstream: docker compose -f docker-compose.test.yml logs -f pool-downstream
#
# PORTS:
#   Upstream:
#     - Stratum: 4242 (miners connect here)
#     - WebUI:   8080
#     - Trusted: 4244 (downstream connects here)
#
#   Downstream:
#     - Stratum: 5242 (miners connect here)
#     - WebUI:   8081
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Monero Daemon (monerod) - Shared
  # ---------------------------------------------------------------------------
  monerod:
    image: ghcr.io/sethforprivacy/simple-monerod:latest
    container_name: monerod-test
    restart: unless-stopped
    ports:
      - "18080:18080"  # P2P network
      - "18081:18081"  # RPC (restricted)
    volumes:
      - C:\MoneroPool\blockchain:/home/monero/.bitmonero
    command:
      - "--rpc-bind-ip=0.0.0.0"
      - "--rpc-bind-port=18081"
      - "--confirm-external-bind"
      - "--restricted-rpc"
      - "--no-igd"
      - "--enable-dns-blocklist"
      - "--prune-blockchain"
    networks:
      - test-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Monero Wallet RPC (for payouts) - Shared
  # ---------------------------------------------------------------------------
  monero-wallet-rpc:
    image: ghcr.io/sethforprivacy/simple-monero-wallet-rpc:latest
    container_name: monero-wallet-rpc-test
    restart: unless-stopped
    depends_on:
      - monerod
    ports:
      - "28084:28084"
    volumes:
      - C:\MoneroPool\wallet:/home/monero/wallet
      - C:\MoneroPool\config:/config:ro
    command:
      - "--daemon-host=monerod"
      - "--daemon-port=18081"
      - "--rpc-bind-port=28084"
      - "--wallet-file=/home/monero/wallet/pool-wallet"
      - "--password-file=/config/wallet-password.txt"
      - "--disable-rpc-login"
    networks:
      - test-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Pool UPSTREAM (Master) - Écoute sur trusted-port 4244
  # ---------------------------------------------------------------------------
  pool-upstream:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pool-upstream
    restart: unless-stopped
    depends_on:
      - monerod
      - monero-wallet-rpc
    ports:
      - "4242:4242"    # Stratum port (miners connect here)
      - "4244:4244"    # Trusted port (downstream connects here)
      - "8080:80"      # Web UI
    volumes:
      - C:\MoneroPool\test-upstream-data:/app/data
      - ./pool-upstream.conf:/app/config/pool.conf:ro
    environment:
      - TZ=Europe/Paris
    networks:
      - test-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Pool DOWNSTREAM (Slave) - Se connecte à l'upstream
  # ---------------------------------------------------------------------------
  pool-downstream:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pool-downstream
    restart: unless-stopped
    depends_on:
      - monerod
      - monero-wallet-rpc
      - pool-upstream
    ports:
      - "5242:4242"    # Stratum port (miners connect here - different port on host)
      - "8081:80"      # Web UI (different port on host)
    volumes:
      - C:\MoneroPool\test-downstream-data:/app/data
      - ./pool-downstream.conf:/app/config/pool.conf:ro
    environment:
      - TZ=Europe/Paris
    networks:
      - test-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# =============================================================================
# Networks
# =============================================================================
networks:
  test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
